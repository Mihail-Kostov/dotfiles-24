#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# Mail
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ......................................................................... Send

# Usage: mailqueue [purge]

# disable fish autojump call
export SHELL=dash
. /etc/profile

# send mail poller with error notifier
queue=$HOME/.msmtpqueue
if [ "$1" = purge ] ;then
  rm -rfv $queue/*
  exit
fi

exec 3< "$(readlink -m "$0")"
if ! flock --exclusive --nonblock 3 2>/dev/null ;then
  echo 1>&2 "Instance $(basename $0) already running: exiting."
  ls -l $queue
  exit 1
fi

# trace 'Starting mailqueue..'

# mailqueue daemon (cron task)
if [ $(ls -l $queue | wc -l) -gt 1 ] ;then
  trace 'Sending mail..'
  count=$(echo $(ls -l $queue | wc -l) / 2 | bc)
  # reset any mangled mail permissions
  [ $(stat --format '%a' $HOME/stow/msmtp/.msmtprc) -ne 600 ] && chmod -c 600 $HOME/.msmtprc
  errmsg=$(/usr/local/bin/msmtp-runqueue.sh)
  echo $errmsg
  if echo $errmsg | grep -q FAILURE ;then
    notify critical 'Check Mail Queue..' "$(echo $errmsg | sed -n 2p)"
  else
    [ $count -eq 1 ] && notify low 'Mail Queue' '1 message sent' ||
                        notify low 'Mail Queue' "$count messages sent"
  fi
else
  trace 'No mail'
fi

# vim: set ft=sh: #
