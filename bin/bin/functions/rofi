#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# X11 Dynamic Menu
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ................................................................. Rofi wrapper

# Usage: rofi '<prompt>' [['<select>' | <row>]] [<option>*]

wbg=argb:E0000000
bg=argb:0000000
fg=argb:FFFDF6E3
abg=$bg
hbg=$bg
hfg=argb:FF25C0EF

# leader left or right
lead=right
leader='──────'
INDENT='   '

# .......................................................................... GUI

if hlwm; then
  display=$(herbstclient list_monitors | grep '\[FOCUS\]' | cut -d: -f1)
  width=$(query displaywidth)
else
  # assumes single display
  display=0
  width=$(xrandr | grep ' connected ' | cut -d' ' -f3 | cut -dx -f1)
fi

# fullscreen only fills the herbstluftwm (virtual) monitor coordinates, so to
# fill the actual physical display area, tweak rofi padding and fontsize
# for 2560, 1680 (secondary), 1440, 1024 displays

# set padding and fontsize
padsize() {
  # padding calculation = displaywidth / fontsize * factor
  padding=$(( $1 / $2 * $3 ))
  fontsize=$2
}

# tune padding to displaywidth / (font * factor) for current monitor resolutions in system
if [ $width -gt 1920 ] ;then
  padsize $width 14 '3 / 2'
elif [ $width -gt 1680 ] ;then
  padsize $width 12 '5 / 3'
elif [ $width -gt 1440 ] ;then
  padsize $width 11 2
elif [ $width -gt 1024 ] ;then
  padsize $width 13 2
else
  padsize $width 11 1
fi

# ....................................................................... Prompt

if [ "$1" ] ;then
  prompt="$1  "
  # convert prompt right to lower case
  [ $lead = left ] && prompt="${prompt}$leader   " ||
                      prompt="$leader   $(echo "$prompt" | tr [:upper:] [:lower:])"
  shift
fi


# ....................................................................... Select

if [ "$1" ] ;then
  # if not parameter
  if [ "${1%%-*}" != '' ] ;then
    echo "$1" | grep -q '^[0-9]*$' && select="-selected-row $1" ||
                                      select="-select '$1'"
    shift
  fi
fi

# ......................................................................... Read

input=$(sed "s/^/$INDENT/" |
        eval /usr/bin/rofi -monitor $display \
                           -bw 0 \
                           -font \"$MONOFONT $fontsize\" \
                           -eh 1 \
                           -color-enabled \
                           -color-window $wbg,$wbg \
                           -color-active $bg,$fg,$abg,$hbg,$hfg \
                           -color-normal $bg,$fg,$abg,$hbg,$hfg \
                           -color-urgent $bg,$fg,$abg,$hbg,$hfg \
                           -line-margin $(( $fontsize + 2 )) \
                           -separator-style none \
                           -hide-scrollbar \
                           -width 100 \
                           -padding $padding \
                           -fullscreen \
                           -dmenu -p "\"$prompt\"" -i $select \
                           $@ )

[ $? -ne 0 ] && exit 1
# strip indent from input!
echo "$input" | sed "s/^$INDENT//"

# vim: set ft=sh: #
