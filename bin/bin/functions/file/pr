#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# File
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ........................................................................ Print

usage() {
  echo "usage: [var=..] $(basename $0)  eject | stdin | mail | prev'iew  [<filelist>]"
  echo "       [fontsize=<pointsize>]  [spacing=2]  [preview=true]  $(basename $0) .."
  exit 1
}

# unset for direct printing, set for proofing and latex debugging
# preview=true

# fontsize automatically suppresses line numbering, source code printing assumed otherwise
if [ "$fontsize" ] ;then
  fontsize=$fontsize
  unset linenumbers
else
  fontsize=8
  linenumbers='\linenumbers'
fi
# default 1.5 line spacing (see vim)
[ "$spacing" = "2" ] && spacing='\doublespacing' || spacing='\onehalfspacing'

# ............................................................... Latex preamble

format() {
  # set title, ignore stdin printing
  echo "$1" | grep -q '^/tmp/tmp\.[^ ]*$' || title="$1"
  # latex!
  (cat <<EOF
\documentclass[${fontsize}pt]{article}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{lineno}
\usepackage{setspace}
\pagestyle{fancy}
\fancyhf{}
\lhead{\today}
\chead{$title}
\rhead{\thepage}
\setmainfont[]{PragmataPro}
\renewcommand\linenumberfont{\selectfont\small}
\setlength\linenumbersep{1em}
$linenumbers
$spacing
\geometry{letterpaper,left=100pt,top=75pt,right=50pt,bottom=50pt}
\makeatletter
\newcommand{\verbatimfont}[1]{\def\verbatim@font{#1}}%
\makeatother
\begin{document}
\verbatimfont{\PragmataPro}
\fontsize{${fontsize}pt}{${fontsize}pt}\selectfont
\begin{verbatim}
% need to inject a blank line to preserve top of file!

$(cat "$1")
\end{verbatim}
\end{document}
EOF
  ) | xelatex -jobname="$1" -output-directory=/tmp >/tmp/pr.log
}

# ................................................................ Print options
 
print() {
  format "$1"
  if [ $preview ] ;then
    zathura "/tmp/$1.pdf" 2>&1
  else
    lpr -P $PRINTER "/tmp/$1.pdf"
  fi
}

case $1 in
  h | '') usage ;;

  eject) # force immediate print with hp (escape) reset code
         printf '\033E' | lpr -P $PRINTER ;;

  stdin) stdin=$(mktemp)
         iconv -c -f utf-8 -t ascii >$stdin
         print $stdin
         pr eject
         rm -f $stdin ;;

  mail) # clean up mail header to essential contact information
        sed -nr '/^(Date|From|To|Cc|Subject): /,$p' | \
        pcregrep -vM 'X-SG-EID: (\n|.)*?[=]' | \
        egrep -vEi '^(Accept-Language|authentication-results|Content-.*|Importance|In-Reply-To|List-.*|Message-ID|MIME-Version|received-spf|References|Reply-To|Return-Path|Sender|Thread-Topic|User-Agent|Thread-Index|X-.*|Tags):' | \
        egrep -vE '^ *(boundary=".*"|charset=.*|(dkim|spf|dmarc)=pass .*|\(UTC\)|\[[0-9]*\] (https*|mailto):.*)$' | \
        fontsize=9 pr stdin ;;

  v) preview=true
     print "$2" ;;

  *) while [ $# -gt 0 ]
     do
       # filenames may have blanks, hence, usage of while vs for i in $@
       print "$1"
       shift
     done
     pr eject ;;
esac

# vim: set ft=sh: #
