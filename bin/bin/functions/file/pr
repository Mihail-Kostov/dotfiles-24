#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# File
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ........................................................................ Print

usage() {
  echo "usage: [proof=true]  $(basename $0)  eject | stdin | code | mail | text | wiki  [<filelist>]"
  exit 1
}

# unset for direct printing, set for proofing and latex debugging
proof=true

# text defaults
fontsize=9
linenumbers='\linenumbers'
spacing='\singlespacing'
fold=80

# ............................................................... Latex preamble

format() {
  # set title dependent on source, ignore stdin
  if echo "$1" | grep -qv '^/tmp/tmp\.[^ ]*$' ;then
    case "$PWD" in
      */.config*) pwd=".config/${PWD#*/.config}" ;;
      */.vim*)    pwd=".vim/${PWD#*/.vim}" ;;
      */bin/bin*) pwd="${PWD#*/bin/bin/}" ;;
      */bin*)     pwd="${PWD#*/bin/}" ;;
      */build*)   pwd="${PWD#*/build/}" ;;
      */vimwiki*) ;;
      *)          pwd="$PWD" ;;
    esac
    [ $pwd ] && title="$pwd/$1" || title="$1"
  fi 

  (cat <<EOF
\documentclass[]{article}
\usepackage{etoolbox}
\usepackage{fp}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{lineno}
\usepackage{setspace}
\pagestyle{fancy}
\FPadd\hdrsize{$fontsize}{\ifnumgreater{$fontsize}{6}{-1}{0}}
% bold header
% \newcommand{\hdrfont}{\bfseries\fontsize{\hdrsize}{\hdrsize}\selectfont}%
\newcommand{\hdrfont}{\fontsize{\hdrsize}{\hdrsize}\selectfont}%
\fancyhf{}
% lighten header underline (0 to turn off)
\renewcommand{\headrulewidth}{0.1pt}
\fancyhead[L]{\hdrfont{\ifstrempty{$time}{\today}{$time}}}
\fancyhead[C]{\hdrfont{$title}}
\fancyhead[R]{\hdrfont{\thepage}}
\setmainfont[]{PragmataPro}
\renewcommand\linenumberfont{\selectfont}%
\setlength\linenumbersep{1em}
$linenumbers
$spacing
\geometry{letterpaper,left=100pt,top=75pt,right=50pt,bottom=50pt}
\makeatletter
\newcommand{\verbatimfont}[1]{\def\verbatim@font{#1}}%
\makeatother
\begin{document}
\verbatimfont{\PragmataPro}
\normalfont\fontsize{$fontsize}{$fontsize}\selectfont
\begin{verbatim}
% need to inject a blank line before cat to preserve top of file!

$(cat "$1")
\end{verbatim}
\end{document}
EOF
  ) | xelatex -jobname="${1#/tmp/}" -output-directory=/tmp >/tmp/pr.log
}

# ............................................................... Mail functions

filter() {
  # reduce mail header to essential contact information
  sed -nr '/^(Date|From|To|Cc|Subject): /,$p' | \
  pcregrep -vM 'X-SG-EID: (\n|.)*?[=]' | \
  egrep -vEi '^(Accept-Language|authentication-results|Content-.*|Importance|In-Reply-To|List-.*|Message-ID|MIME-Version|received-spf|References|Reply-To|Return-Path|Sender|Thread-Topic|User-Agent|Thread-Index|X-.*|Tags):' | \
  egrep -vE '^ *(boundary=".*"|charset=.*|(dkim|spf|dmarc)=pass .*|\(UTC\)|\[[0-9]*\] (https*|mailto):.*)$'
}

header() {
  title=$(grep -m 1 '^Subject:' $stdin \
        | cut -d' ' -f2- \
        | sed -re 's/^ *([Rr][Ee]: )+//' \
              -e 's/^ *([Ff][Ww][Dd]*: )+//' \
              -e 's/(\[SPAM\])//')

  time=$(grep -m 1 '^Date:' $stdin \
       | cut -d' ' -f2-5)
  time=$(date -d "$time" +'%B %-d, %Y')
}

# ................................................................ Print options

print() {
  output="/tmp/${1#/tmp/}.pdf"
  rm -f "$output" 2>&1
  format "$1"
  if [ $proof ] ;then
    zathura "$output" 2>&1
  else
    notify "Printing" "$title"
    lpr -P $PRINTER "$output"
  fi
}

# lines from stdin are folded
stdin() {
  stdin=$(mktemp)
  iconv -c -f utf-8 -t ascii | fold -sw $fold >$stdin
  # set (title, time) format values, see case mail below
  [ "$*" ] && $@
  print $stdin
  rm -f $stdin
  pr eject
}

case "$1" in
  h | '') usage ;;

  eject) # force last page ejection with hp (escape) reset code
         [ $proof ] || printf '\033E' | lpr -P $PRINTER
         exit ;;

  stdin) stdin ;;

  mail) # content is piped in from mail application, see alot
        fontsize=9
        spacing='\onehalfspacing'
        unset linenumbers
        filter | stdin header ;;

  text) fontsize=9
        spacing='\singlespacing'
        linenumbers='\linenumbers' ;;

  wiki) fontsize=10
        spacing='\doublespacing'
        unset linenumbers ;;

  code | *) fontsize=8
            spacing='\onehalfspacing'
            linenumbers='\linenumbers'
            [ "$1" = code ] || noshift=true ;;
esac
[ $noshift ] || shift

# process filelist
while [ $# -gt 0 ]
do
  # filenames may have blanks, hence, usage of while vs for i in $@
  print "$1"
  shift
done
pr eject

# vim: set ft=sh: #
