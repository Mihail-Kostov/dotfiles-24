#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# File
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ............................................................... Sync nfs share

# Usage: syncnfs [<path>]*
#
# Note: Local networked arm devices (raspberry pi's) nfs share server:~/stow
#       on mount point ~/stownfs and mirror this on the SD storage device ~/stow.
#       This juggling is implemented purely for arm SD file performance over NFS

watch=$HOME/.syncnfs
log=/tmp/syncnfs.log

[ -e $watch ] || touch $watch
# server is always online but satellite arm device may be offline (and sync on boot)
server && { ping -c 1 -W 1 pi >/dev/null 2>&1 || exit; }

# register modified source file directories (projects), see buffers.vim
# note: vim filespec must not be symbolic link!
if [ $1 ] ;then
  for i in $@
  do
    echo $i | grep -q "^$HOME/stow" || continue
    grep -x $i $watch || echo $i >>$watch
  done
else
  if [ -s $watch ] ;then
    trace "Sync vim edits..\n${_YELLOW_}$(cat $watch)" >>$log
    trap "> $watch" EXIT
    # sync mirrored directories, see dev v script
    for i in $(sort -u $watch)
    do
      if cpu arm ;then
        target=$HOME/stownfs${i#$HOME/stow}
        rsync $i ${target%/*}/ >>$log
      else
        rsync $i pi:${i%/*}/ >>$log
      fi
    done
  fi
fi

# vim: set ft=sh: #
