#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# Dev
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ......................................................... Revision differences

usage() {
  echo "usage: $(basename $0) <package> [filter]"
  exit 1
}

# diff current sources with dotfiles git repo
dotfiles=/net/depot/dotfiles
current=$HOME/stow
ignore='backups|build|debian|makepkg|nixos|plugged|plugged-custom|plugin|qmk_firmware|root|snippets|vps'

[ $1 ] || usage
[ -d $HOME/stow/$1 ] || usage

if ! if-no "sync $dotfiles repo" ;then
  rm -rf $dotfiles
  git clone git@github.com:sdothum/dotfiles.git $dotfiles
fi

if [ $2 ] ;then
  filter=$2
else
  filter="$ignore"
  exclude=-v
fi

for i in $(find $current/$1 -type f | egrep -v '/[.](deprecated|git|hg|history|vimv)' | egrep $exclude $filter)
do
  file=${i#*/stow/*/}
  unset blink
  while :
  do
    echo "${_green_}${blink}-> $file${_nocolor_}"
    if ! diff $i $dotfiles/$1/$file ;then
      # see herbstluftwm gvimdiff rule
      if-no "edit $file" && break ||
                            gvimdiff -f --role=gvimdiff $i $dotfiles/$1/$file
      blink=${_blink_}
    else
      break
    fi
  done
done

# vim: set ft=sh: #
