#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# Hardware
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ....................................................................... Planck

usage() {
  echo "usage: $(basename $0) <keymap> [colemak|qwerty] [<string>] [dfu]"
  exit 1
}

QMK=$HOME/qmk_firmware
PLANCK=$QMK/keyboards/planck
KEYMAP=$PLANCK/keymaps/$1

[ $1 ] || usage
keymap=$1
shift

if ! if-no 'sync qmk_firmware repo' ;then
  original -f -q $QMK
  cd $QMK
  git pull
fi

# default keymap
case $1 in
  qwerty) sed -i 's|.*COLEMAK|// #define COLEMAK COLEMAK|' $KEYMAP/config.h ;;
  *     ) sed -i 's|.*COLEMAK|#define COLEMAK COLEMAK|' $KEYMAP/config.h ;;
esac

if [ "$1" = qwerty ] || [ "$1" = colemak ] ;then
  shift
fi

# compile time macro sting
grep -q COMPILE_STRING $KEYMAP/config.h || sed -i '$a#define COMPILE_STRING' $KEYMAP/config.h
case $1 in
  '' | dfu) sed -i 's|.*COMPILE_STRING|// #define COMPILE_STRING|' $KEYMAP/config.h ;;

  *) sed -i 's/.*COMPILE_STRING/#define COMPILE_STRING/' $KEYMAP/config.h
     echo "SEND_STRING(\"$1\");" >$KEYMAP/compile_string.h
     shift ;;
esac

cd $PLANCK
sudo make clean >/dev/null
sudo make KEYMAP=$keymap $1
sudo chown -R $USER:users $QMK
rm -f $KEYMAP/compile_string.h

# vim: set ft=sh: #
