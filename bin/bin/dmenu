#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# X11 Dynamic Menu
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ........................................................... Dmenu rofi wrapper

# Usage: dmenu <function>
# Note:  non-dmenu messages within $0/functions/dmenu
#        source $HOME/bin/dmenu
#        POSIX standard for use with dash shell

CACHEDIR=${XDG_CACHE_HOME:-$HOME/.cache}

# content formatting items
SEP='∙'
LSPACE="    $SEP"
RSPACE="$SEP    "
INDENT='   '
UTF='□'

leader='──────'
fg='#FDF6E3'
hlfg='#25C0EF'
# hlbg='black'
hlbg='#070707'

# allow subword match input (by inserting single quote symbol into input)
unquote() {
  echo "$@" | sed "s/'//g"
}

# Rofi fullscreen fill specs
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# -fullscreen only fills the herbstluftwm (virtual) monitor coordinates, so to
# fill the actual physical display area, tweak rofi padding, fontsize and lines
# for 2560, 1680 (secondary), 1440, 1024 displays
if hlwm; then
  if is primary ;then
    if is display =2560 ;then
      padding=410
      fontsize=18
      lines=12
    elif is display =1440 ;then
      padding=200
      fontsize=14
      lines=10
    elif is display =1360 ;then
      padding=220
      fontsize=16
      lines=10
    else
      padding=110
      fontsize=14
      lines=7
    fi
  else
    # 1680 secondary monitor
    padding=230
    fontsize=16
    lines=10
  fi
else 
  padding=200
  fontsize=14
  lines=10
fi

hlwm && monitor=$(herbstclient list_monitors | grep '\[FOCUS\]' | cut -d: -f1) \
                              || monitor=0

# Available apps
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# return list of existing applications
apps() {
  unset apps
  for i in $@
  do
    # allow user named browser scripts
    # apps="$apps$(which $i >/dev/null 2>&1 && echo "$i ")"
    if [ -n "$(find /usr/bin -name $i)" ] ;then 
      apps="$apps$i "
    fi
  done
  echo $apps | sed 's/ /\n/g'
}

# Media player playlist
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# usage:  playlist library played, see dmenu series/movies
playlist() {
  cat "$2" | while read line
  do
    [ "$line" ] && grep -q "$line" "$1" && sed -i "/^$line/s/^$line/$line $SEP/" "$1"
  done
  cat "$1"
}

# playlist order
sortlist() {
  [ "$*" ] && echo 'sort by name' || echo 'sort by date'
}

# Source wrapper
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
# dmenu wrapper for sourced apps
# usage: dmenu '<prompt>' ['<select>' | -filter '<filter>'] [<option>*]
dmenu() {
  # prompt string
  if [ "$1" ] ;then
    prompt="$1  "
    shift
  fi

  # select string
  unset select
  if [ "$1" ] ;then
    # if not parameter
    if [ "${1%%-*}" != '' ] ;then
      select="$1"
      shift
    fi
  fi

  # filter option (must precede remaining option list)
  unset filter
  if [ "$1" = '-filter' ] ;then
    filter="$2"
    shift 2
  fi

  # use blank -mesg as added separator and indent pick list!
  input=$(sed "s/^/$INDENT/" \
        | rofi -monitor $monitor -hide-scrollbar -padding $padding \
               -bw 0 -eh 2 -opacity 85 \
               -color-enabled -color-window black \
               -color-normal "black,$fg,black,$hlbg,$hlfg" \
               -color-active "black,$fg,black,$hlbg,$hlfg" \
               -color-urgent "black,$fg,black,$hlbg,$hlfg" \
               -font "PragmataPro $fontsize" \
               -lines $lines -width 100 -fixed-num-lines -separator-style none \
               -dmenu -p "${prompt}$leader   " -i -mesg ' ' -select "$select" -filter "$filter" $@ \
        )
  # strip indent from input!
  [ $? -eq 0 ] && echo "$input" | sed "s/^$INDENT//" || return 1
}

# Main
# ▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔

# if not sourced, execute dmenu message
if [ $(basename $0) = dmenu ] ;then
  # if hlwm; then
  #   fullscreen mode windows hide dmenu
  #   if query fullscreen ;then
  #     toggle fullscreen
  #     fullscreen=true
  #   fi
  # fi
  msg=$1
  shift
  if [ -e ${0%/dmenu}/functions/dmenu/$msg ] ;then
    . ${0%/dmenu}/functions/dmenu/$msg $@
  else
    usage $0
  fi
  # restore
  hlwm && [ $fullscreen ] && toggle fullscreen
fi

# vim: set ft=sh: #
