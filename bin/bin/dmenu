#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# X11 Dynamic Menu
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# .................................................................... Dmenu DSL

# Usage: dmenu [-] <function>
#              where, '-' forces ncurses mode
# Note:  non-dmenu messages within $0/functions/dmenu
#        source $HOME/bin/dmenu
#        POSIX standard for use with dash shell

CONFIG=${0%/dmenu}/functions/dmenu/.config
export HISTORY=$HOME/bin/functions/dmenu/.history
# currently playing, see music, radia
MUSIC=/tmp/audio:music
RADIO=/tmp/audio:radio

# content formatting items, see herbstluftwm env
LSPACE="    $SEP"
RSPACE="$SEP    "
UTF='□'

# ............................................................... Available apps

# return list of existing applications
apps() {
  unset apps
  for i in $@
  do
    # if [ -n "$(find /usr/bin -name $i)" ] ;then
    #   apps="$apps$i "
    # fi
    # allow user named browser scripts
    apps="$apps$(which $i >/dev/null 2>&1 && echo "$i ")"
  done
  echo $apps | sed 's/ /\n/g'
}

# ........................................................ Media player playlist

# usage:  playlist library played, see dmenu series/movies
playlist() {
  cat $2 | while read line
  do
    [ "$line" ] && grep -q "$line" $1 &&
                   sed -i "/^$line/s/^$line/$line $SEP/" $1
  done
  cat $1
}

# playlist order
sortlist() {
  [ $1 ] && echo 'sort by name' || echo 'sort by date'
}

# .......................................................... Most recent history

# usage: previous <function>, refer to history usage in dmenu functions
previous() {
  echo | history $1 | head -1
}

# ......................................................................... Main

# allow subword match input (by inserting single quote symbol into input)
unquote() {
  echo $@ | sed "s/'//g"
}

# if not sourced, execute dmenu message
if [ $(basename $0) = dmenu ] ;then
  # see toggle dmenu for persistent ncurses mode
  if [ "$1" = '-' ] ;then
    export NCURSES=ncurses
    shift
  fi
  msg=$1
  shift
  if [ -e ${0%/dmenu}/functions/dmenu/$msg ] ;then
    . ${0%/dmenu}/functions/dmenu/$msg $@
  else
    usage $0
  fi
  # restore
  hlwm && [ $fullscreen ] && toggle fullscreen
  # pidof gpaste-clieunt >/dev/null || gpaste-client &
fi
unset NCURSES

# vim: set ft=sh: #
